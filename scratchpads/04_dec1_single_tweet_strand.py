# %%

import pandas as pd
import numpy as np
from supabase import create_client, Client
from datetime import datetime, timedelta, timezone  
import os
import json
from pathlib import Path
from dotenv import load_dotenv

from lib.conversation_explorer import build_conversation_trees, build_incomplete_conversation_trees, build_quote_trees, print_conversation_threads
from lib.count_quotes import count_quotes
from lib.create_ascii_chart import create_ascii_chart
from tqdm import tqdm
import pickle
from lib.count_quotes import count_quotes

# Load environment variables
load_dotenv()
# %%
#ENRICHED_TWEETS_PATH = '/Users/frsc/Documents/Projects/data/2025-09-03_enriched_tweets.parquet' # for francisco
ENRICHED_TWEETS_PATH = '~/data/enriched_tweets.parquet' # for alexandre

tweets = pd.read_parquet(ENRICHED_TWEETS_PATH, dtype_backend='pyarrow')
tweets = tweets.set_index('tweet_id', drop=False)
# %% General plan

# make_fishbones(seeds):
# - fishbones = []
# - For seed in seeds:
#     - quotes = get_all_quotes(seed)
#     - threads = make_thread(quotes)
#         - # maybe modify the function, so that non-roots also give their whole thread
#     - fishbones.append(thread)
# - return fishbones.sort_thread(by=root_date)

# get_strand(tweet_id):
# - other_seeds = filtered_semantic_search(tweet_id)
# - fishbones = make_fishbones(other_seeds + tweet_id)
# - display(fishbones)

# %%

tweet_id = 1796556282339443189

# %%

# make tweets into a list of tweets as a dict where each key is a column name
#tweets_list = tweets.to_dict(orient='records')


# %%
# %%
# Check if quoted counts cache exists
quoted_counts_cache_path = Path('quoted_counts_cache.parquet')

if quoted_counts_cache_path.exists():
    print("Loading quoted counts from cache...")
    quoted_counts = pd.read_parquet(quoted_counts_cache_path)
else:
    print("Calculating quoted counts...")
    quoted_counts = count_quotes(tweets)
    quoted_counts = quoted_counts.groupby('quoted_tweet_id', as_index=False)['quoted_count'].sum()
    # Save to cache
    quoted_counts.to_parquet(quoted_counts_cache_path)
    print(f"Saved quoted counts cache to {quoted_counts_cache_path}")

tweets = tweets.merge(
    quoted_counts,
    left_index=True,
    right_on='quoted_tweet_id',
    how='left',
    suffixes=('', '_drop')
)
# Drop the duplicate quoted_tweet_id column from the merge
tweets = tweets.drop(columns=['quoted_tweet_id_drop'], errors='ignore')
# Fill NaN values with 0 for tweets that were never quoted
tweets['quoted_count'] = tweets['quoted_count'].fillna(0).astype(int)
# Reset index if index name is 'index' to avoid ambiguity when setting it again
if tweets.index.name == 'index':
    tweets = tweets.reset_index(drop=False)
# Now set tweet_id as index (it should only be a column at this point)
tweets = tweets.set_index('tweet_id', drop=False)
tweets.index.name = 'index'


# %%
# Convert DataFrame to list of dicts - use pandas built-in method (much faster)
# This is orders of magnitude faster than nested loops (typically 100-1000x faster)
print("Converting tweets DataFrame to list of dictionaries...")
tweets_list = tweets.to_dict(orient='records')
print(f"Converted {len(tweets_list)} tweets successfully.")


# %%

del(tweets)
# Alternative if to_dict doesn't work (still much faster than nested loops):
# tweets_list = [dict(zip(tweets.columns, row)) for row in tqdm(tweets.itertuples(index=False), 
#                                                                 desc="Converting tweets to list", 
#                                                                 total=len(tweets))]


# %%

tweet_dict = {tweet['tweet_id']: tweet for tweet in tweets_list}

# %%

conversation_tweet_list = [tweet for tweet in tweets_list if tweet['conversation_id'] is not None]
# %%
trees =  build_conversation_trees(conversation_tweet_list)
# %%
non_conversation_tweet_list = [tweet for tweet in tweets_list if tweet['conversation_id'] is None]

# %%
incomplete_trees =  build_incomplete_conversation_trees(non_conversation_tweet_list, [])

# %% merge complete conversation trees, incomplete conversation trees, and quote trees
complete_reply_trees = {**trees, **incomplete_trees}

# %%

# quote_trees = build_quote_trees(tweets_list) # not used for now but it runs without errors

# %%
tweet_dict = {tweet['tweet_id']: tweet for tweet in tweets_list}
# %%
import pickle
import os

# Define paths for cached data
TWEET_DICT_CACHE = 'tweet_dict_cache.pkl'
REPLY_TREES_CACHE = 'complete_reply_trees_cache.pkl'
OVERRIDE_CACHE = False
# Check if cached files exist and load them
if os.path.exists(TWEET_DICT_CACHE) and os.path.exists(REPLY_TREES_CACHE) and not OVERRIDE_CACHE:
    print("Loading cached tweet_dict and complete_reply_trees...")
    with open(TWEET_DICT_CACHE, 'rb') as f:
        tweet_dict = pickle.load(f)
    print(f"Loaded {len(tweet_dict)} tweets from cache.")
    with open(REPLY_TREES_CACHE, 'rb') as f:
        complete_reply_trees = pickle.load(f)
    print("Cached data loaded successfully.")
else:
    print("Cache not found. Saving tweet_dict and complete_reply_trees...")
    # Save the computed data for future use
    with open(TWEET_DICT_CACHE, 'wb') as f:
        pickle.dump(tweet_dict, f)
    with open(REPLY_TREES_CACHE, 'wb') as f:
        pickle.dump(complete_reply_trees, f)
    print("Data cached successfully.")

# %%
# let's make an index  quoted_tweet_id -> quote tweets
quote_tweets_dict = {}
for tweet in tweet_dict.values():
    if tweet['quoted_tweet_id'] is not None:
        quote_tweets_dict[tweet['quoted_tweet_id']] = quote_tweets_dict.get(tweet['quoted_tweet_id'], []) + [tweet['tweet_id']]
# %%
# okay let's produce a strand.

from lib.semantic_search import search_embeddings
# %%
tweet_id = 1742494880625016921
results = search_embeddings(tweet_dict[tweet_id]['full_text'], k=100, threshold=0.5, exclude_tweet_id=tweet_id,
    #                         filter={"must_not": [
    # { "key": "text", "match": { "text": "community" } },
    # { "key": "text", "match": { "text": "communities" } },
    # { "key": "text", "match": { "text": "build" } },
    # { "key": "text", "match": { "text": "building" } },
    # { "key": "text", "match": { "text": "builder" } },
    # { "key": "text", "match": { "text": "scale" } },
    
    # ]}
)
# %%
print('\n'.join(list(map(lambda x: f'{x["distance"]} - {x["key"]} - {x["metadata"]["text"]}', results))))
# %%
result_ids = [int(result['key']) for result in results]
print(len(result_ids))
result_dicts = [tweet_dict[result_id] for result_id in result_ids if result_id in tweet_dict]
print(len(result_dicts))
# %%
# print ones that aren't in tweet_dict
print('\n'.join([str(r) for r in results if int(r['key']) not in tweet_dict]))
# %%
def semantic_search_for_strands(tweet_id, exclude_tweet_ids=[], exclude_keywords=[]):
    results = search_embeddings(tweet_dict[tweet_id]['full_text'], k=1000, threshold=0.5, exclude_tweet_id=str(tweet_id), filter={"must_not": [{"key": "text", "match": {"text": keyword}} for keyword in exclude_keywords]})
    result_ids = [int(result['key']) for result in results]
    result_dicts = [tweet_dict[result_id] for result_id in result_ids if result_id in tweet_dict]
    filtered_result_dicts = [result_dict for result_dict in result_dicts if (int(result_dict['quoted_tweet_id']) != tweet_id if result_dict['quoted_tweet_id'] is not None else True)]
    good_result_dicts = sorted(filtered_result_dicts, key=lambda x: x['quoted_count'], reverse=True)[:20]
    return good_result_dicts
# %%
good_semantic_result_dicts = semantic_search_for_strands(tweet_id)
print(len(good_semantic_result_dicts))
# %%
print('\n===\n'.join([f'{r["tweet_id"]} - {r["quoted_count"]} - {r["full_text"][:100]}...' for r in good_semantic_result_dicts]))
# %%
from lib.conversation_explorer import EnrichedTweet
from typing import Literal
from dataclasses import dataclass

@dataclass
class StrandSeed:
    tweet_id: int
    source_type: Literal['root', 'semantic_search', 'quote_of_root', 'quote_of_semantic_search'] 
    
# %%
# let's skip filtering semantic search results with LLMs for now

# we take search results, we find all the tweets that are quoting them with quote_tweets_dict, and then we use each of those as seeds to print threads
strand_seeds =  [StrandSeed(tweet_id=tweet_id, source_type='root')] + [
    StrandSeed(tweet_id=seed_tweet_id, source_type='quote_of_root') 
    for seed_tweet_id in quote_tweets_dict.get(tweet_id, [])
] + [
    StrandSeed(tweet_id=tweet['tweet_id'], source_type='semantic_search') 
    for tweet in good_semantic_result_dicts
] + [
    StrandSeed(tweet_id=seed_tweet_id, source_type='quote_of_semantic_search') 
    for tweet in good_semantic_result_dicts
    for seed_tweet_id in quote_tweets_dict.get(tweet['tweet_id'], [])
]
print(len(strand_seeds))
# %%
from lib.conversation_explorer import print_conversation_threads


rich_tweet_seeds = [1742494880625016921,1766341602870439953,1743553890916683831,1904114702143406303,1904047011277549651,1742737462516961459,1742500854802907205,1743080673613869124,1743555207852589493,1766279606351605884,1743078860714065945,1742532614215303314,1766613778307613096,1742621652586836197,1942262762656153873,1743008082081333327,1743529282092114427,1942260183125655617,1802971123136835720,1742555103033282639,1742497228407652396,1742791214934683660,1823179794940322030,1716140468751204826,1796691790608613791,1333199165589864449,1742496635899220139,1662169476521918473,1568102136067522560,1106499777880117248,1828043128139309328,1241409748156776448,1742542390722757024,1743036689227067568,1742583689035600274,1742520437303574676,1742505647026172179,1464240020169109504,1742495067695116459,1097450506484678657,17605701792,2332251318,1437660721676967945,1718975693671780673,1788628945434239416,1788626702303731824,1742602108925333640,1716527363549233374,1896954590270259411,1832538740234797111,1832372146514886734,1805306207529230515,1333199309408509953,1743544377534799999,1662170980628742164,1568102636855128064,1106591531073363968,1828187749746385258,1241740706353491968,1241516112023638022,1241410050788384768,1242456603523153920]

ice_cream_tweet_seeds = [1206274875112841217,1285353971054452741,1293884729901514753,1712449665302433822,1455068457091756034,1455961711282950145,1479318450082246657,1495469643250769926,1524411385987448832,1541547654890459136,1544679054636650497,1548554123121143810,1556873230819868674,1570202180300439552,1574342815429304320,1574597642864435200,1585624132984897538,1596236933142675456,1610720789535547392,1617509945607614467,1633615145749430272,1633983452927098882,1635906191351070720,1641112234406588419,1657526292055756800,1664383827916242944,1671299588190347264,1681414359547822115,1705686577156948040,1706286151600922845,1706654787587002783,1706854501036990467,1736459003184726270,1739581970341048703,1746714030637723965,1755627229399412982,1758145964857057359,1760368738526810446,1763522294972825787,1787687643523981737,1796064466309673360,1802789577364828411,1812185236782133617,1823486601101762975,1825215571551723780,1828489015298761129,1847916573463380416,1854686902622077288,1901758653843349876,1901909392418803747,1902431111587737899,1911518954146652266,1921222298972860736,1929022991439896645,1939459055015059808,1950019772927619417,1959659316463714776,1960763883171487843,1976051431783456920,1976297706000708034,1976319699765035361,1976398841952993306,1977717862061015073,1978294190829134278,1979336460148051972,1980761507676975324,1984521367354491132,1996265854686884108]

house_norm_seeds = [1139237044306292737,1259564748997308419,1271235106590474240,1311094543593271297,1352361115569819653,1444956998882115586,1444961828681830402,1449680951278293000,1450685539825319938,1459068390669176832,1463263785767088135,1464784752259608581,1470505499716108303,1472956318105452547,1508826017066065921,1514655314594832428,1539950758317154311,1562947275806035968,1605471492354953217,1655962943387729920,1683515395200913408,1689977722104078336,1702254781962527223,1708706248299004257,1717168590535671840,1725493926964899847,1727016854928183557,1727030336415228050,1728472940964937800,1728473772070515125,1728582692114235731,1733017888498561274,1740125408052543577,1744826512917102894,1744829228963770604,1751663712014893496,1768761170305892651,1769008060142325889,1839856413322940720,1856004764800258552,1869478292262457676,1893006741035532771,1902452734261129242,1905218445689667695,1911882342475407850,1922241543710162956,1948488614213541972,1952745764024623544,1961452696868995504,1961451396139823496,1961496400816214063,1963496158598242753,1966184376854790294,1988529780883440019,1988559061827158131]

everything_is_monocausal = [967114911401652225,968366985452179456,1016369585115688960,1021455196990234625,1025052421028962305,1032806447514497024,1060149241698533376,1065298827081629696,1065303782286856198,1071597850260172800,1078739242921017344,1084624592453349376,1086446771922817024,1093233216738058240,1096062485059137536,1100543504718225408,1104965390650826752,1105628387727433728,1108583152170074112,1109270449525907458,1109906935967420416,1110735730819526656,1114222617047646209,1120445900877389825,1156233165012230145,1158535350538555392,1160081474114035713,1161689657924415491,1161728280451571712,1162165471707193344,1169649685369212928,1173672589635575809,1193402787704401925,1203589005377277952,1204678012731449346,1207837956477616128,1209169331189235712,1214783774115811329,1214966701604761600,1218740187145965570,1223069753863917569,1227170775695798272,1227337128507510785,1232321183468548097,1237528669993594880,1242616830646198273,1246139067072270337,1266073227832356864,1266843058642944000,1271437218448433153,1274102637382660096,1277691455499198464,1281060578912432128,1284899496997117957,1286407868518789122,1299398671931326464,1302365575750983680,1305310759727935488,1308356027201589251,1341071127800516609,1331327166022291456,1335188961279479814,1338847939721093121,1346195655887376385,1346534489514680320,1347177436773896194,1347305345442402305,1347320847384543232,1348920193095925761,1350656562008793088,1351585609207353344,1353445194499153926,1354926320623394818,1359401700570718213,1365993430397157378,1368839430795038720,1374252822154276867,1387058294603362306,1387500793083826176,1397430932596948996,1401402631013253120,1401578792636731397,1401984918813478917,1414678179273347073,1415764227940179968,1431365315221344257,1432507262828830721,1449044385564291074,1454086877871415296,1455905074979299333,1460288121191424005,1470203497568034816,1470903059236724736,1478916157612593153,1483901967990603776,1486275911213142016,1490251595766026242,1491512823536574464,1493768688553496576,1497695865300942848,1498200121967849472,1508692761775550465,1512086821739503617,1512306579508453379,1529476569189818371,1535325142699606016,1563305136554131457,1565362524563832840,1594024085582974977,1601401582964207616,1602515174958604288,1616380624415195137,1619082239786237952,1621022545700081664,1623037082158436374,1624064405938794497,1625323858201903105,1625794848040308737,1630041621642264586,1630245848566362113,1631389493327437860,1631886007128694788,1632269298080133123,1634165749727084547,1639833615038119936,1645919366440173568,1649835118201298944,1650220757463756800,1673798431645597698,1693462157755916637,1695807004202197251,1708540628097700126,1713734658091843745,1729626270500364637,1732026470086680769,1737026587722125688,1754649294546841747,1764530899578671203,1772792045934903403,1773118584006340964,1773504785993314775,1790201847845957924,1793347213193617907,1795022615687401731,1795637349164143101,1796653394091823250,1805386304550846865,1814529955042070601,1814649768355705306,1835365855229608164,1836388457477747056,1842082238709539172,1847916770390139275,1898526651824120064,1899965365079146763,1975638104527741134,1996281315730092344]


a_lot_of_woo_is_true = [1402959297315753986,1486706027236147202,1559860328502108161,1620842654572625920,1636283081903464448,1641175236245860352,1696929961267896377,1708248206654509142,1721168982537875727,1808655836459454504,1808682169646109116,1808870183836025027,1808876403552661857,1808876933565792573,1808941901984510164,1809207348486943199,1809616563366162587,1809618263497929124,1812503721269432695,1812614805611855929,1815936065095582129,1816456897664266307,1871689903706382665,1872327528951820418,1873297395179749691,1880351909766480230,1880360562259001349,1888026137911038395,1904470231810031722,1907525309039259799,1920349015163752854,1932932392898928777,1937714987990167742,1953442723412705685,1956722942043390078]

friend_group = [1464288020987879428,1534095581727141889,1545415364653318146,1575139150289948674,1601018902040879105,1612657007290449920,1612657646397706241,1617271829000765440,1622118228431364097,1622118047493259264,1622256579205791745,1622294265509339142,1622659424689979392,1623101839976677376,1685115446670839808,1688950434910679043,1738442800151081109,1746214914165727308,1747845112682393769,1762954958654013525,1766244821264416924,1768319161237917888,1768746922238730399,1769254822568440252,1776381264750129371,1778587150725812647,1778604865515565090,1787216296993804657,1787474989005812117,1792151684447183044,1906903975703765250,1932293125390922000,1943365633024082175,1947428903716589615,1955283736565780582,1955289409147875525,1956166491835129878]

denfense_against_dark_art = [1321555815799533570,1321556297670483969,1375215619793117189,1391954336112996390,1391959698501341186,1453963522476371980,1474971203349663744,1573909275738374144,1620855486332694528,1631754595604238337,1637667603413094401,1653110917540765711,1665398268241559552,1696897388886053201,1741448181316022469,1741353867609018497,1741355777443705205,1741474868388827324,1741549626619216333,1741596746373828961,1741849803795976229,1755211321422053566,1782254817999564855,1798442868484579605,1813718954977984732,1814376535253721340,1892825481038483694,1917289783384277231,1918685079573807431,1930008255859998984,1940232878849425464,1956367588134363559,1963605664388808844,1966882253864071411,1967559640138559542]


favorite_picture = [1516655821291016194,1509901921561194497,1509935963463688201,1695148441347952843,1744446593741230561,1745988068937511230,1745989301651792080,1745991222634930597,1746048382232150107,1746201424583589968,1758019631363592593,1764079355854999900,1893890551562264940,1907167721395240963,1918093915498135945,1932094246003040726,1933683168445673731,1940217777656365304,1940254756108476474,1940262055011033515,1940264278134841446,1940265326438134146,1940339641301045321,1940412728092573764,1940420801095950765,1940494134416232552,1959421600631226453,1959665226812703158]


joke = [1183968983881379840,1200796982266224642,1265999987810488322,1386074617916264450,1414586838979915778,1439067975370227723,1439352353564491781,1439467975728263170,1440532511600230406,1440928592653733896,1442440508966457344,1445268688043601921,1449810549349306371,1449993852358594560,1450069983229198338,1451100520483995656,1452180881011998724,1454318631832064006,1454792145374625792,1454924038405455872,1458678420280205312,1461041649870458885,1464906743750676480,1546544161448673280,1469239905645592577,1475742685780606981,1483032182092607489,1496029473309065216,1502387996804337667,1504506718176571395,1506853498205671427,1510858759458865152,1525950374586519553,1531378904363151361,1532720639554953216,1574274710354862080,1583099717650505728,1583101411457261568,1587407678472474624,1587884451417055232,1590580178677551104,1596627234072440832,1600382961912025088,1600700946354700288,1608397481146208257,1610360803219345408,1613764423847673856,1616682643248287744,1619746901569716224,1626522036687503360,1637262049364279296,1637504745676865536,1638429489473388544,1640971364667650048,1642315604727037953,1643074174770880514,1646916656432840705,1647291746207019008,1649753618663493632,1661308206638075904,1662033062925049856,1667224703092805632,1667225139325575170,1674176299303333889,1675509420997111808,1677297505627779072,1678520227158433795,1690757756926717952,1696183039595069951,1705121685891112992,1705740540401340583,1715753335398252639,1719822449767068100,1720530326072725924,1720650090401190026,1723741346136027543,1726294290215940283,1730124721348350175,1743030046221373950,1747563307094233425,1751282173242736760,1753617019134693697,1755745962822414565,1755979501618577706,1759799110616412487,1772057572989960442,1776709982144041294,1796159968854319221,1806866664983797959,1816156104524718204,1827038203158917370,1842045056150347888,1844097073580474436,1861604929242308747,1872472918900543996,1915789475747356813]

conversation_threads = print_conversation_threads(
    tweet_ids=joke,
    conversation_trees=complete_reply_trees,
    tweets=tweet_dict,
    depth=20
)

with open('joke.txt', 'w') as f:
    f.write(conversation_threads)

# write to file for convenience
# with open('conversation_threads.txt', 'w') as f:
#     f.write(conversation_threads)
# %%
print(','.join([str(seed.tweet_id) for seed in strand_seeds]))
# /multi-thread-visualizer?tweet_ids=1742494880625016921,1766341602870439953,1743553890916683831,1904114702143406303,1904047011277549651,1742737462516961459,1742500854802907205,1743080673613869124,1743555207852589493,1766279606351605884,1743078860714065945,1742532614215303314,1766613778307613096,1742621652586836197,1942262762656153873,1743008082081333327,1743529282092114427,1942260183125655617,1802971123136835720,1742555103033282639,1742497228407652396,1742791214934683660,1823179794940322030,1716140468751204826,1796691790608613791,1333199165589864449,1742496635899220139,1662169476521918473,1568102136067522560,1106499777880117248,1828043128139309328,1241409748156776448,1742542390722757024,1743036689227067568,1742583689035600274,1742520437303574676,1742505647026172179,1464240020169109504,1742495067695116459,1097450506484678657,17605701792,2332251318,1437660721676967945,1718975693671780673,1788628945434239416,1788626702303731824,1742602108925333640,1716527363549233374,1896954590270259411,1832538740234797111,1832372146514886734,1805306207529230515,1333199309408509953,1743544377534799999,1662170980628742164,1568102636855128064,1106591531073363968,1828187749746385258,1241740706353491968,1241516112023638022,1241410050788384768,1242456603523153920
